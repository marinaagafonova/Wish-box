
@model Wish_Box.ViewModels.UserPageViewModel
@{
    ViewData["Title"] = Model.User.Login;
    bool flag = false;
}

<div class="col-8 col-lg-8">
    <div class="user-info">
        <div style="width: 200px;height: 200px; float:left;">
            @if (Model.User.Avatar != null)
            {
                <img class="avatar" style="width: 200px;height: 200px;" src="@Url.Content(Model.User.Avatar)" />
            }
            else
            {
                <img class="avatar" style="width: 200px;height: 200px;" src="~/Content/default_profile.jpg" />
            }
        </div>
        <div class="user-info-block">
            <label class="user-name">@Model.User.Login</label>
            <br />
            <label class="user-place">@Model.User.City, @Model.User.Country</label>
            <div class="user-date">
                <img src="~/Content/calendar-512.png" style="width: 30px; height: 30px; margin-right: 5px;" />
                <label class="user-date-lb">@Model.User.dayOfBirth.ToShortDateString()</label>
            </div>
        </div>
        @if (Model.User.Login == User.Identity.Name)
        {
            <a class="btn btn-light btn-lg edit-profile" asp-area="" asp-controller="Account" asp-action="Edit">Редактировать профиль</a>
        }
        else
        {
            @if (!Model.Followers.Contains(Model.CurrentUser.Id))
            {
                <a class="follow-btn" asp-controller="Followings" asp-action="Add" asp-route-id="@Model.User.Id" id="follow" onclick="ym(62193592, 'reachGoal', 'follow'); return true;">Подписаться</a>
                if (flag)
                {
                    Model.Followers.Add(Model.User.Id);
                    flag = false;
                }
            }
            else
            {
                <a class="btn btn-ligh unfollow-btn" asp-controller="Followings" asp-action="Remove" asp-route-id="@Model.User.Id" id="unfollow">Отписаться</a>
                if (flag)
                {
                    Model.Followers.Remove(Model.User.Id);
                    flag = false;
                }
            }
        }
    </div>

    <div class="wishes">
        @foreach (var wish in Model.UserWishes)
        {

            @if (wish.UserId == Model.User.Id)
            {
                <div class="col-auto">
                    <div class="wish-show row">
                        @if (Model.User.Login == Model.CurrentUser.Login)
                        {
                        <div class="row">
                            <div class="dropdown" style="margin-left:auto; margin-right: 20px;">

                                <button onclick="myFunction(@wish.Id)" class="dropbtn">&#8226;&#8226;&#8226;</button>
                                @{
                                    string drop_id = "myDropdown" + wish.Id.ToString();
                                }
                                <div id="@drop_id" class="dropdown-content">
                                    <a asp-controller="Wish" asp-action="Edit" asp-route-id="@wish.Id">Редактировать желание</a>
                                    <a class="btn-delete" asp-controller="Wish" asp-action="Delete" asp-route-id="@wish.Id">Удалить желание</a>
                                </div>

                            </div>
                        </div>
                        }
                        <div class="col-12">
                            <div class="desc-block col-8">
                                <label class="wish-desc">@wish.Description</label>

                            </div>
                            <div class="attachment col-4">
                                @if (wish.Attachment != null)
                                {
                                    <img src="@Url.Content(wish.Attachment)" />
                                }
                                else
                                {
                                    <img src="~/Content/gift.png" />
                                }
                            </div>

                        </div>
                        <div class="wish-func col-12">
                            <a class="btn btn-get-comments" style="margin-right: 20px; float:left;" asp-controller="Comments" asp-action="GetComments" asp-route-id="@wish.Id" data-id="@(wish.Id)">
                                <img class="icon" style="width: 40px;height: 40px;" src="~/Content/comment.png" />
                            </a>

                            @if (Model.User.Login != Model.CurrentUser.Login)
                            {<a asp-controller="Wish" asp-action="RatingPlus" asp-route-id="@wish.Id" onclick="ym(62193592, 'reachGoal', 'rate_wish'); return true;" style="float:left"> <img class="icon" style="width: 14px;height: 35px;" src="~/Content/ratingPlus available.png" /></a>}

                            <label class="rating-desc" style="float:left;">Рейтинг: @wish.Rating.ToString()</label>

                            @if (Model.User.Login != Model.CurrentUser.Login)
                            {<a asp-controller="Wish" asp-action="RatingMinus" asp-route-id="@wish.Id" onclick="ym(62193592, 'reachGoal', 'rate_wish'); return true;" style="float: left"> <img class="icon" style="width: 14px;height: 35px;" src="~/Content/ratingMinus available.png" /></a>}


                            @if (Model.User.Login != Model.CurrentUser.Login)
                            {

                                @if (Model.TakenWishes.Contains(wish.Id))
                                {
                                    <form asp-controller="ToGive" asp-action="Remove" asp-route-id="@wish.Id" method="post" style="float:left;">
                                        <button class="btn btn-add-to-give-mark" type="submit"><img class="icon" style="width: 39px;height: 30px;" src="~/Content/tick_to_give.png" />Добавлено в "Подарить"</button>

                                    </form>
                                }
                                else
                                {
                                    <form asp-controller="ToGive" asp-action="Add" asp-route-id="@wish.Id" method="post" onsubmit="ym(62193592, 'reachGoal', 'to_give'); return true;" style="float:left;">
                                        <button class="btn btn-add-to-give-mark" type="submit"><img class="icon" style="width: 30px;height: 30px;" src="~/Content/plus.png" />Добавить в "Подарить"</button>
                                    </form>
                                }
                            }
                        </div>

                    </div>
                 <div class="comment-block comment-section-@(wish.Id)"></div>
             </div>
            }
        }
    </div>
</div>


<script>
    function myFunction(id) {
        console.log(id);
        //console.log("myDropdown"+id);
        document.getElementById("myDropdown" + id).classList.toggle("show");
    }
    window.onclick = function (event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }
</script>

@section scripts
{
    <script type="text/javascript">

        $(function () {
            $.ajaxSetup({ cache: false });
            $(".btn-delete").click(function (e) {
                console.log("delete button was pressed");
                e.preventDefault();
                $.get(this.href, function (data) {
                    $('#dialogContent').html(data);
                    $('#modDialog').modal('show');
                });
            });
        })
    </script>

    <script type="text/javascript">
        $(function () {
            $.ajaxSetup({ cache: false });
            $(".btn-get-comments").click(function (e) {
                console.log("comments button was pressed");
                ym(62193592, 'reachGoal', 'get_comments');
                e.preventDefault();
                var id = $(this).attr("data-id");
                $.get(this.href, function (data) {
                    $('.comment-section-' + id).empty();
                    $('.comment-section-' + id).prepend(data);
                });
            });
        })
    </script>
}

<script>
    follow.onclick = function (event) {
        console.log("follow button was pressed");
      @{flag = true;}
    }
    unfollow.onclick = function (event) {
        console.log("unfollow button was pressed");
      @{flag = true;}
    }
</script>
