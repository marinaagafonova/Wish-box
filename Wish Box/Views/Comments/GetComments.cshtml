@model CommentViewModel
@using Wish_Box.ViewModels;

@{
    ViewData["Title"] = "GetComments";
}

@if (Model != null)
{

    foreach (CommentViewModel commentVM in ViewBag.list)
    {
    <div class="row" style="margin-top:10px;">

        <div style="width: 90%; margin-left: 20px;">
            <a class="btn-default user-link" asp-controller="UserPage" asp-action="Show" asp-route-id="@commentVM.AuthorName">
                @if (commentVM.Avatar != null)
                {
                    <img class="avatar" style='width:55px; height:55px;' src="@Url.Content(commentVM.Avatar)" />
                }
                else
                {
                    <img class="avatar" src="~/Content/default_profile.jpg" asp-append-version="true" width="55"
                         height="55" alt="My profile">
                }
                @commentVM.AuthorName
            </a>

        </div>
        @if (commentVM.AuthorName == User.Identity.Name)
        {
            <div style="float:right">
                <form asp-controller="Comments" asp-action="Delete" asp-route-id="@commentVM.Id" method="post">
                    <input class="btn" type="submit" value="x" />
                </form>
            </div>
        }
        <div class="commentDetails" style="width: 100%;">
            <p style="margin-left: 30px; margin-top: 10px; font-size: 16px;"> @commentVM.Description </p>
        </div>
        @if (commentVM.InReplyId != null)
        {
            <div style="width:100%; margin-left: 40px;">
                <div>
                    This comment is the reply for comment:  
                    @foreach (CommentViewModel com in ViewBag.list)
                    {
                        @if (com.Id == commentVM.InReplyId)
                        {
                            <label>@com.Description</label>
                            break;
                        }
                    }
                </div>
            </div>
        }


        <div><input type="button" class="btn btn-reply btn-outline-info" style="width:auto; margin-left:20px;" data-desc="@commentVM.Description" data-id="@commentVM.Id" value="Ответить" /></div>
    </div>
    }
    <form class="border-top" asp-controller="Comments" asp-action="AddComment" method="post" onsubmit="ym(62193592, 'reachGoal', 'add_comment'); return true;" style="margin-top:20px;">
        <div class="form-group">
            <div class="col-auto" style="margin-left: 10px;">
                <input type="hidden" asp-for="WishId" />
                <input type="hidden" asp-for="AuthorName" value="@User.Identity.Name" />
                <div class="reply"></div>
                <input style="margin-top: 10px;" type="text" asp-for="Description"
                       class="form-control" placeholder="Добавить комментарий..." />
                <input style="margin-top: 10px;" class="btn btn-outline-success" type="submit" value="Отправить" />
            </div>
        </div>
    </form>
}

<script type="text/javascript">
    $(function () {
        $.ajaxSetup({ cache: false });
        $(".btn-reply").click(function (e) {
            console.log("reply button was pressed");
            e.preventDefault();
            var id = $(this).attr("data-id");
            var desc = $(this).attr("data-desc");
            $(function () {
                $('.reply').empty();
                $('.reply').prepend('<input type="hidden" id="InReplyId" name="InReplyId" value="' + id + '"' + '/' + '>' + 'В ответ на комментарий "' + desc + '"');
            });
        });
    })
</script>
